import re
import requests
from bs4 import BeautifulSoup


REQUEST_URL = "https://transport.dot.state.mn.us/PostLetting/Abstract.aspx"


def get_post_letting_abstract_html(year: int) -> str:
    # The payload below was copied from the post request after navigating to the target page manually
    payload = {
        "__EVENTTARGET": "ctl00$MainContent$drpPage",
        "__EVENTARGUMENT": "",
        "__LASTFOCUS": "",
        "__VIEWSTATE": "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",
        "__VIEWSTATEGENERATOR": "CB5059B5",
        "__EVENTVALIDATION": "/wEdAEP3lT6HWe2T/qZT1jg1VZHr1/kROgTaTEDUErshDOtcHsyahhkwrDiNSR++FA7PlkqrxiY7QpuAA0OZi5lL4D3HxyQFCASK8RL+UbY3E2huli7thzHE0E+j4yeu77j/cuL1n0g50y16EsAZSTp7rZXgKcVvnREc1KtWrK7ZJPrFMIbwhkDVqGWTjtz0WCQfM1sQvn1btmpgTxTZ49/qiW9oB5W0Es4OZq4Mog1Cdbtzm1XTNjiNSeGvI6qv5qkeDyElG7os7J/5R5IxDD8SF9lFSWOZ3h9KgfV4FtnQKMqcTuY7P7+U+/4RbCH2mPwXlldrGAo5Y6ZurhIKerVfoJS4PoC6WJiOlXiY1JUvB3SfYrIAlTq9hPOIvvrXH8dOZzmP9AeEN29PLdmg7X8RcwCx2dscEWTR/YRu20PZOcRLzqkburaYqOwREsOwJimqrE3W90fzKbc8Yy7aGYejx/+11yBGDJMU4xydlwo68+wctUoLjbrTQsuN54E+e4oAO6MsijzAv1NMd39MddCImrrT4Jpc9TJbT00f71L0w6HijnjS2R2COqKzQzW0s5U7KbwNodnyARXFPMmvdfWng4TcF7/2QPaIIJVO4a8ZxbmMb8UpO+RXn6gpzKeVTlZDRCIhRYKQIvLsmRfIf/i0c9FlL5udmpcglh67HnBhprGtD96mW9t/bzTpwPlioqeF7ljvXL1Xk4ZbzswCZDjlMdUWtfRbfAB1dHv0+CZCyfOtBdiLDHk12dywOX17ofEuLUSh3aPjqBjgGlr8sv1gplNAPCd2hYD+TwFECtNCI9UgFQFs5Vjaoe/+QR+3kIu4VrB24gQ2/wHSvCFsDwT12Vvn8A7yyqWrMhaIAK4tk2FafxDV788bJz+O3EwT274rbJr7NTeTpjFkJQyLrlGDQfXG2TINHyYX8bK0B+ys//4Kqv+mb6GLwl9LxK9QUGzVm+kpbGJsd25kvRHxlm4vW5i7N4nZSndBEmSI+IQ/jHkKh4zW9ICRMhHa6/lGd9XS1i5zhvwObWjkzCi8ajse/I+aY7mdQH02SOGdaMD13i8jnTWwOOL0aZBP+P3G4CPkNtRun4egZG2D+1v4sv8J6q+i3HWMLyu9HsT37j7GsYedCYG7XtnAPoBU7Ph9dbk4T+fG0L/Fmv5bwniDphcKb4QaiYuj3Ru/zh0XTdVBotnaPzvnKv858NI2zf51LeJ+myK91w6SXDnHPyXvG6KB49B7C3MiUYDBZ4qEJ81kl0OcmCKIQHIW5qsqii+8GDOMMrQSQmfmgT2OqDO2fzPbenzp3rvvbNUZgJJeaVheZfkNN/d5m33tB2LYGSmdVp/rxcpnSmCYf1DOOdvP1OY/m5Hzf2zLdj1jSVOeJH0hFKnfT4CWlL2u4QQIq++b9To9fHuSk1CgPbNJ1+KDyoZyMS55vzaHt7I77ppbJHLG2yKOX6ZOjrFZNbuO1LG8gr7K0HA=",
        "ctl00$MainContent$rdAbstractSearch": "0",
        "ctl00$MainContent$drpLettingYear": str(year),
        "ctl00$MainContent$drpLettingMonth": "0",
        "ctl00$MainContent$drpPage": "20000",
    }

    r = requests.post(url=REQUEST_URL, data=payload)
    return r.text


def get_ids_from_html(html: str) -> list[str]:
    soup = BeautifulSoup(html, "html.parser")

    # Get a list of all anchor tags for the Abstract (CSV)
    # Example tag: <a href="abstractCSV.aspx?ContractId=210006" target="_blank">
    regex = re.compile("ContractId")
    anchors = soup.find_all(href=regex)

    # The last 6 digits of the href is the contract id
    return [anchor.get("href")[-6:] for anchor in anchors]


def get_contract_ids(year: int) -> list[str]:
    html = get_post_letting_abstract_html(year)
    return get_ids_from_html(html)
